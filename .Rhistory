)
# Save
write.table(
file = "Zhang_count/merged_spacer_counts.txt",
x = filtered_counts,
sep = "\t",
quote = F,
row.names = F
)
### Set working directory
setwd("/media/testuser/SSD_4/jfreeland/OwenWitte/CRISPR/Github/Abt_Wang_E2F3/")
### Load packages
library(readr)
library(dplyr)
library(purrr)
library(stringr)
library(biomaRt)
### Read and merge all sgRNA count files
files <- list.files("Zhang_count", pattern = "_spacer_counts.tsv$", full.names = TRUE)
merged_counts <- files %>%
purrr::map(readr::read_csv) %>%
purrr::reduce(dplyr::full_join, by = "seq") %>%
as.data.frame()
### Load library annotation and filter for protein coding genes
library <- readr::read_delim(
"Reference/Human_GeckoV2_library_a_b_merged.txt",
delim = ",",
col_names = c("sgRNA", "seq", "Gene")
)
# Identify all protein coding genes in library
ensembl <- biomaRt::useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")
gene_list <- unique(library$Gene)
gene_annot <- biomaRt::getBM(
attributes = c("hgnc_symbol", "gene_biotype"),
filters = "hgnc_symbol",
values = gene_list,
mart = ensembl) %>%
dplyr::filter(gene_biotype == "protein_coding")
# Filter library and merge with counts
library_pc <- library %>%
dplyr::filter(Gene %in% gene_annot$hgnc_symbol)
merged_counts_lib <- dplyr::inner_join(library_pc, merged_counts, by = "seq") %>%
dplyr::select(-seq)
### Set working directory
setwd("/media/testuser/SSD_4/jfreeland/OwenWitte/CRISPR/Github/Abt_Wang_E2F3/")
### Load packages
library(readr)
library(dplyr)
library(purrr)
library(stringr)
library(biomaRt)
### Read and merge all sgRNA count files
files <- list.files("Zhang_count", pattern = "_spacer_counts.tsv$", full.names = TRUE)
merged_counts <- files %>%
purrr::map(readr::read_csv) %>%
purrr::reduce(dplyr::full_join, by = "seq") %>%
as.data.frame()
### Load library annotation and filter for protein coding genes
library <- readr::read_delim(
"Reference/Human_GeckoV2_library_a_b_merged.txt",
delim = ",",
col_names = c("sgRNA", "seq", "Gene")
)
# Identify all protein coding genes in library
ensembl <- biomaRt::useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")
gene_list <- unique(library$Gene)
gene_annot <- biomaRt::getBM(
attributes = c("hgnc_symbol", "gene_biotype"),
filters = "hgnc_symbol",
values = gene_list,
mart = ensembl) %>%
dplyr::filter(gene_biotype == "protein_coding")
# Filter library and merge with counts
library_pc <- library %>%
dplyr::filter(Gene %in% gene_annot$hgnc_symbol)
merged_counts_lib <- dplyr::inner_join(library_pc, merged_counts, by = "seq") %>%
dplyr::select(-seq)
# Get starting matierial sample names
st_cols <- grep("\\-ST$", colnames(merged_counts_lib), value = TRUE)
# Sum total counts per sample
st_totals <- colSums(merged_counts_lib[, st_cols])
# Remove guides under 1 per million reads
st_above_thresh <- sweep(merged_counts_lib[, st_cols], 2, st_totals, FUN = "/") > 1e-6
keep_rows <- apply(st_above_thresh, 1, all)
filtered_counts <- merged_counts_lib[keep_rows, ] # 64181 guides
View(filtered_counts)
filtered_counts[1:4,1:5]
library(dplyr)
library(stringr)
# 1) Identify starting-material columns (adjust the pattern if yours differs)
st_cols <- names(filtered_counts) %>% str_detect("-ST$") %>% which()
st_cols <- names(filtered_counts)[st_cols]
# 2) For each Gene, count how many sgRNAs have >0 reads in each ST sample
gene_pass <- filtered_counts %>%
group_by(Gene) %>%
summarise(across(all_of(st_cols), ~sum(.x > 0), .names = "{.col}"), .groups = "drop") %>%
# gene must have >=3 sgRNAs in *every* ST column
rowwise() %>%
mutate(min_guides_any_st = min(c_across(all_of(st_cols)))) %>%
ungroup() %>%
filter(min_guides_any_st >= 3) %>%
pull(Gene)
# 3) Keep only those genes across *all* samples (drop every row for failing genes)
filtered_counts_keep <- filtered_counts %>%
filter(Gene %in% gene_pass)
# 2) For each Gene, count how many sgRNAs have >0 reads in each ST sample
gene_pass <- filtered_counts %>%
group_by(Gene) %>%
summarise(across(all_of(st_cols), ~sum(.x > 0), .names = "{.col}"), .groups = "drop") %>%
# gene must have >=3 sgRNAs in *every* ST column
rowwise() %>%
mutate(min_guides_any_st = min(c_across(all_of(st_cols)))) %>%
ungroup() %>%
filter(min_guides_any_st >= 4) %>%
pull(Gene)
# 3) Keep only those genes across *all* samples (drop every row for failing genes)
filtered_counts_keep <- filtered_counts %>%
filter(Gene %in% gene_pass)
dim(filtered_counts)
dim(filtered_counts_keep)
write.table(
file = "Zhang_count/merged_spacer_counts_FILT.txt",
x = filtered_counts_keep,
sep = "\t",
quote = F,
row.names = F
)
# 2) For each Gene, count how many sgRNAs have >0 reads in each ST sample
gene_pass <- filtered_counts %>%
group_by(Gene) %>%
summarise(across(all_of(st_cols), ~sum(.x > 0), .names = "{.col}"), .groups = "drop") %>%
# gene must have >=3 sgRNAs in *every* ST column
rowwise() %>%
mutate(min_guides_any_st = min(c_across(all_of(st_cols)))) %>%
ungroup() %>%
filter(min_guides_any_st >= 3) %>%
pull(Gene)
# 3) Keep only those genes across *all* samples (drop every row for failing genes)
filtered_counts_keep <- filtered_counts %>%
filter(Gene %in% gene_pass)
write.table(
file = "Zhang_count/merged_spacer_counts_FILT.txt",
x = filtered_counts_keep,
sep = "\t",
quote = F,
row.names = F
)
##### Set up #####
setwd("/media/testuser/SSD_4/jfreeland/OwenWitte/Evan/")
### Pull in data and create shared file
Counts_Evan <- read.table(
file = "Data/Evan_20240220_rsem_genes_raw_counts_UQN_log2.txt",
sep = "\t",
header = T
) %>%
tibble::column_to_rownames(var = "gene")
Counts_CCLE <- read.table(
file = "Data/CCLE_expect_quartilenorm_log2_summed.txt",
sep = "\t",
header = T
) %>%
tibble::column_to_rownames(var = "gene")
Counts_Endpoint <- read.table(
file = "Data/TimeCourse_endpoint_rsem_genes_raw_counts_UQN_log2.txt",
sep = "\t",
header = T
) %>%
tibble::column_to_rownames(var = "gene")
shared_genes <- Reduce(intersect,
list(rownames(Counts_Evan),
rownames(Counts_CCLE),
rownames(Counts_Endpoint)
)
)
Counts_Evan <- Counts_Evan[rownames(Counts_Evan) %in% shared_genes, ]
Counts_CCLE <- Counts_CCLE[rownames(Counts_CCLE) %in% shared_genes, ]
Counts_Endpoint <- Counts_Endpoint[rownames(Counts_Endpoint) %in% shared_genes, ]
Counts_CCLE_Evan <- merge(Counts_Evan, Counts_CCLE, by = "row.names") %>%
tibble::column_to_rownames(var = "Row.names")
Counts_CCLE_Evan_Endpoint <- merge(Counts_CCLE_Evan, Counts_Endpoint, by = "row.names") %>%
tibble::column_to_rownames(var = "Row.names")
### Pull in signatures
RB1_Chen_list_long <- list() # 448
setwd("/media/testuser/SSD_4/jfreeland/Freeland/Github/FDB_Freeland/") # linux
library(doParallel)
library(doRNG)
library(missForest)
install.package(c("doParallel", "doRNG", "missForest"))
install.packages(c("doParallel", "doRNG", "missForest"))
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/DataSets/DepMap_25Q3/CRISPRGeneEffect.csv"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = ","
)
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/CRISPRGeneEffect.csv"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = ","
)
table(colSums(is.na(CRISPR)))
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
library(doParallel)
library(doRNG)
library(missForest)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
dim(CRISPR_mf)
str(CRISPR_mf)
CRISPR_mf.imp <- CRISPR_mf$ximp
CRISPR_mf.imp_t <- as.data.frame(
t(CRISPR_mf.imp),
stringsAsFactors = F
)
file.crispr
gsub(".csv$","_MFImputed.txt",file.crispr)
# save
write.table(
x = CRISPR_mf.imp,
file = gsub(".csv$","_MFImputed.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
write.table(
x = CRISPR_mf.imp_t,
file = gsub(".csv$","_MFImputed_sg.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/ctrpv2.wide_culled80.txt"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = ","
)
View(CRISPR)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "/t"
)
CRISPR <- read.delim(
file = file.crispr,
stringsAsFactors = F,
sep = "/t"
)
CRISPR <- read.delim(
file = file.crispr,
stringsAsFactors = F,
sep = "
\t"
)
CRISPR <- read.delim(
file = file.crispr,
stringsAsFactors = F,
sep = "\t"
)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t"
)
CRISPR <- read.delim(
file = file.crispr,
stringsAsFactors = F,
sep = "\t"
)
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/ctrpv2.wide_culled80.txt"
CRISPR <- read.delim(
file = file.crispr,
row.names = T,
stringsAsFactors = F,
sep = "\t"
)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t"
)
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/ctrpv2.wide_culled80.txt"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t"
)
table(colSums(is.na(CRISPR)))
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
CRISPR_mf.imp <- CRISPR_mf$ximp
CRISPR_mf.imp_t <- as.data.frame(
t(CRISPR_mf.imp),
stringsAsFactors = F
)
# save
write.table(
x = CRISPR_mf.imp,
file = gsub(".(csv|txt)$","_MFImputed.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
write.table(
x = CRISPR_mf.imp_t,
file = gsub(".(csv|txt)$","_MFImputed_sg.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
##### Set up #####
setwd("~/Documents/GitHub/FDB_Freeland/") # mac
setwd("/media/testuser/SSD_4/jfreeland/Freeland/Github/FDB_Freeland/") # linux
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/ctrpv2.wide_culled80.txt"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t"
)
View(CRISPR)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t",
check.names = F
)
table(colSums(is.na(CRISPR)))
View(CRISPR[, "nutlin-3"])
View(data.frame(CRISPR[, "nutlin-3"]))
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t",
check.names = F
)
table(colSums(is.na(CRISPR)))
CRISPR_nutline <- CRISPR[ , grep()"nutlin", colnames(CRISPR), ignore.case = TRUE), drop = FALSE]
CRISPR_nutline <- CRISPR[ , grep("nutlin", colnames(CRISPR), ignore.case = TRUE), drop = FALSE]
View(CRISPR_nutline)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t"
# check.names = F
)
CRISPR_nutline <- CRISPR[ , grep("nutlin", colnames(CRISPR), ignore.case = TRUE), drop = FALSE]
View(CRISPR_nutline)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t"
# check.names = F
)
table(colSums(is.na(CRISPR)))
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = "\t",
check.names = F
)
table(colSums(is.na(CRISPR)))
CRISPR_nutline <- CRISPR[ , grep("nutlin", colnames(CRISPR), ignore.case = TRUE), drop = FALSE]
View(CRISPR_nutline)
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
CRISPR_mf.imp <- CRISPR_mf$ximp
CRISPR_mf.imp_t <- as.data.frame(
t(CRISPR_mf.imp),
stringsAsFactors = F
)
# save
write.table(
x = CRISPR_mf.imp,
file = gsub(".(csv|txt)$","_MFImputed.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
write.table(
x = CRISPR_mf.imp_t,
file = gsub(".(csv|txt)$","_MFImputed_sg.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
View(CRISPR_mf.imp)
View(CRISPR_mf.imp_t)
gsub(".(csv|txt)$","_MFImputed_sg.txt",file.crispr)
setwd("/media/testuser/SSD_4/jfreeland/Freeland/Github/FDB_Freeland/") # linux
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/D2_combined_gene_dep_scores.csv"
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/D2_combined_gene_dep_scores.csv"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = ",",
check.names = F
)
# pull in data
file.crispr <- "/media/testuser/SSD_4/jfreeland/Freeland/Github/data/D2_combined_gene_dep_scores.csv"
CRISPR <- read.delim(
file = file.crispr,
row.names = 1,
stringsAsFactors = F,
sep = ",",
check.names = F
)
View(CRISPR)
table(colSums(is.na(CRISPR)))
# miss forest
doParallel::registerDoParallel(cores = detectCores() - 2)
doRNG::registerDoRNG(seed = 999)
set.seed(999)
CRISPR_mf <- missForest(
xmis = CRISPR,
parallelize = "variables",
verbose = T
)
CRISPR_mf.imp <- CRISPR_mf$ximp
CRISPR_mf.imp_t <- as.data.frame(
t(CRISPR_mf.imp),
stringsAsFactors = F
)
# save
write.table(
x = CRISPR_mf.imp,
file = gsub(".(csv|txt)$","_MFImputed.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
write.table(
x = CRISPR_mf.imp_t,
file = gsub(".(csv|txt)$","_MFImputed_sg.txt",file.crispr),
quote = F,
sep = "\t",
col.names = NA
)
